
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "generated/autoexamples/GPU/example_learn_straight_line_readouts.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_generated_autoexamples_GPU_example_learn_straight_line_readouts.py>`
        to download the full example code. or to run this example in your browser via Binder

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_generated_autoexamples_GPU_example_learn_straight_line_readouts.py:


===================================
Learn Straight line readout pattern
===================================

A small pytorch example to showcase learning k-space sampling patterns.
In this example we learn the 2D sampling pattern for a 3D MRI image, assuming
straight line readouts. This example showcases the auto-diff capabilities of the NUFFT operator
The image resolution is kept small to reduce computation time.

.. warning::
    This example only showcases the autodiff capabilities, the learned sampling pattern is not scanner compliant as the scanner gradients required to implement it violate the hardware constraints. In practice, a projection :math:`\Pi_\mathcal{Q}(\mathbf{K})` into the scanner constraints set :math:`\mathcal{Q}` is recommended (see [Proj]_). This is implemented in the proprietary SPARKLING package [Sparks]_. Users are encouraged to contact the authors if they want to use it.

.. GENERATED FROM PYTHON SOURCE LINES 17-21

.. colab-link::
   :needs_gpu: 1

   !pip install mri-nufft[gpunufft]

.. GENERATED FROM PYTHON SOURCE LINES 24-26

Imports
-------

.. GENERATED FROM PYTHON SOURCE LINES 26-39

.. code-block:: Python

    import time
    import joblib

    import brainweb_dl as bwdl
    import matplotlib.pyplot as plt
    import numpy as np
    import torch
    from tqdm import tqdm
    from PIL import Image, ImageSequence

    from mrinufft import get_operator









.. GENERATED FROM PYTHON SOURCE LINES 40-45

Setup a simple class to learn trajectory
----------------------------------------
.. note::
    While we are only learning the NUFFT operator, we still need the gradient `wrt_data=True` to have all the gradients computed correctly.
    See [Projector]_ for more details.

.. GENERATED FROM PYTHON SOURCE LINES 45-115

.. code-block:: Python



    class Model(torch.nn.Module):
        def __init__(self, num_shots, img_size, factor_cartesian=0.3):
            super(Model, self).__init__()
            self.num_samples_per_shot = 128
            cart_del = 1 / img_size[0]
            num_cart_points = np.round(np.sqrt(factor_cartesian * num_shots)).astype(int)
            edge_center = cart_del * num_cart_points / 2

            self.central_points = torch.nn.Parameter(
                data=torch.stack(
                    torch.meshgrid(
                        torch.linspace(-edge_center, edge_center, num_cart_points),
                        torch.linspace(-edge_center, edge_center, num_cart_points),
                        indexing="ij",
                    ),
                    axis=-1,
                ).reshape(-1, 2),
                requires_grad=False,
            )
            self.non_center_points = torch.nn.Parameter(
                data=torch.Tensor(
                    np.random.random((num_shots - self.central_points.shape[0], 2)) - 0.5
                ),
                requires_grad=True,
            )
            self.operator = get_operator("gpunufft", wrt_data=True, wrt_traj=True)(
                np.random.random(
                    (self.get_2D_points().shape[0] * self.num_samples_per_shot, 3)
                )
                - 0.5,
                shape=img_size,
                density=True,
                squeeze_dims=False,
            )

        def get_trajectory(self, get_as_shot=False):
            samples = self._get_3D_points(self.get_2D_points())
            if not get_as_shot:
                return samples
            return samples.reshape(-1, self.num_samples_per_shot, 3)

        def get_2D_points(self):
            return torch.vstack([self.central_points, self.non_center_points])

        def _get_3D_points(self, samples2D):
            line = torch.linspace(
                -0.5,
                0.5,
                self.num_samples_per_shot,
                device=samples2D.device,
                dtype=samples2D.dtype,
            )
            return torch.stack(
                [
                    line.repeat(samples2D.shape[0], 1),
                    samples2D[:, 0].repeat(self.num_samples_per_shot, 1).T,
                    samples2D[:, 1].repeat(self.num_samples_per_shot, 1).T,
                ],
                dim=-1,
            ).reshape(-1, 3)

        def forward(self, x):
            self.operator.samples = self.get_trajectory()
            kspace = self.operator.op(x)
            adjoint = self.operator.adj_op(kspace).abs()
            return adjoint / torch.mean(adjoint)









.. GENERATED FROM PYTHON SOURCE LINES 116-118

Util function to plot the state of the model
--------------------------------------------

.. GENERATED FROM PYTHON SOURCE LINES 118-163

.. code-block:: Python



    def plot_state(mri_2D, traj, recon, loss=None, save_name=None, i=None):
        fig_grid = (2, 2)
        if loss is None:
            fig_grid = (1, 3)
        fig, axs = plt.subplots(*fig_grid, figsize=tuple(i * 5 for i in fig_grid[::-1]))
        axs = axs.flatten()
        axs[0].imshow(np.abs(mri_2D[0][..., 11]), cmap="gray")
        axs[0].axis("off")
        axs[0].set_title("MR Image")
        if traj.shape[-1] == 3:
            if i is not None and i > 50:
                axs[1].scatter(*traj.T[1:3, 0], s=10, color="blue")
            else:
                fig_kwargs = {}
                plt_kwargs = {"s": 1, "alpha": 0.2}
                if i is not None:
                    fig_kwargs["azim"], fig_kwargs["elev"] = (
                        i / 50 * 60 - 60,
                        30 - i / 50 * 30,
                    )
                    plt_kwargs["alpha"] = 0.2 + 0.8 * i / 50
                    plt_kwargs["s"] = 1 + 9 * i / 50
                axs[1].remove()
                axs[1] = fig.add_subplot(*fig_grid, 2, projection="3d", **fig_kwargs)
                for shot in traj:
                    axs[1].scatter(*shot.T, color="blue", **plt_kwargs)
        else:
            axs[1].scatter(*traj.T, s=10)
        axs[1].set_title("Trajectory")
        axs[2].imshow(np.abs(recon[0][0][..., 11].detach().cpu().numpy()), cmap="gray")
        axs[2].axis("off")
        axs[2].set_title("Reconstruction")
        if loss is not None:
            axs[3].plot(loss)
            axs[3].grid("on")
            axs[3].set_title("Loss")
        if save_name is not None:
            plt.savefig(save_name, bbox_inches="tight")
            plt.close()
        else:
            plt.show()









.. GENERATED FROM PYTHON SOURCE LINES 164-166

Setup model and optimizer
-------------------------

.. GENERATED FROM PYTHON SOURCE LINES 166-170

.. code-block:: Python


    cart_data = np.flipud(bwdl.get_mri(4, "T1")).T[::8, ::8, ::8].astype(np.complex64)
    model = Model(253, cart_data.shape)
    optimizer = torch.optim.Adam(model.parameters(), lr=1e-2)







.. GENERATED FROM PYTHON SOURCE LINES 171-173

Setup data
----------

.. GENERATED FROM PYTHON SOURCE LINES 173-179

.. code-block:: Python


    mri_3D = torch.Tensor(cart_data)[None]
    mri_3D = mri_3D / torch.mean(mri_3D)
    model.eval()
    recon = model(mri_3D)
    plot_state(mri_3D, model.get_trajectory(True).detach().cpu().numpy(), recon)



.. image-sg:: /generated/autoexamples/GPU/images/sphx_glr_example_learn_straight_line_readouts_001.png
   :alt: MR Image, Reconstruction, Trajectory
   :srcset: /generated/autoexamples/GPU/images/sphx_glr_example_learn_straight_line_readouts_001.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    /volatile/github-ci-mind-inria/gpu_runner/_work/mri-nufft/mri-nufft/examples/GPU/example_learn_straight_line_readouts.py:174: UserWarning: Casting complex values to real discards the imaginary part (Triggered internally at ../aten/src/ATen/native/Copy.cpp:308.)
      mri_3D = torch.Tensor(cart_data)[None]




.. GENERATED FROM PYTHON SOURCE LINES 180-182

Start training loop
-------------------

.. GENERATED FROM PYTHON SOURCE LINES 182-225

.. code-block:: Python

    losses = []
    image_files = []
    model.train()
    with tqdm(range(100), unit="steps") as tqdms:
        for i in tqdms:
            out = model(mri_3D)
            loss = torch.nn.functional.mse_loss(out, mri_3D[None])
            numpy_loss = loss.detach().cpu().numpy()
            tqdms.set_postfix({"loss": numpy_loss})
            losses.append(numpy_loss)
            optimizer.zero_grad()
            loss.backward()
            optimizer.step()
            with torch.no_grad():
                # Clamp the value of trajectory between [-0.5, 0.5]
                for param in model.parameters():
                    param.clamp_(-0.5, 0.5)
            # Generate images for gif
            hashed = joblib.hash((i, "learn_line", time.time()))
            filename = "/tmp/" + f"{hashed}.png"
            plot_state(
                mri_3D,
                model.get_trajectory(True).detach().cpu().numpy(),
                out,
                losses,
                save_name=filename,
                i=i,
            )
            image_files.append(filename)

    # Make a GIF of all images.
    imgs = [Image.open(img) for img in image_files]
    imgs[0].save(
        "mrinufft_learn_2d_sampling_pattern.gif",
        save_all=True,
        append_images=imgs[1:],
        optimize=False,
        duration=2,
        loop=0,
    )

    # sphinx_gallery_thumbnail_path = 'generated/autoexamples/GPU/images/mrinufft_learn_2d_sampling_pattern.gif'





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

      0%|          | 0/100 [00:00<?, ?steps/s]      0%|          | 0/100 [00:00<?, ?steps/s, loss=0.30024123]      1%|          | 1/100 [00:04<06:50,  4.14s/steps, loss=0.30024123]      1%|          | 1/100 [00:04<06:50,  4.14s/steps, loss=0.28073445]      2%|▏         | 2/100 [00:08<06:58,  4.27s/steps, loss=0.28073445]      2%|▏         | 2/100 [00:08<06:58,  4.27s/steps, loss=0.2711868]       3%|▎         | 3/100 [00:12<06:42,  4.15s/steps, loss=0.2711868]      3%|▎         | 3/100 [00:12<06:42,  4.15s/steps, loss=0.26334482]      4%|▍         | 4/100 [00:16<06:31,  4.07s/steps, loss=0.26334482]      4%|▍         | 4/100 [00:16<06:31,  4.07s/steps, loss=0.26003024]      5%|▌         | 5/100 [00:20<06:20,  4.01s/steps, loss=0.26003024]      5%|▌         | 5/100 [00:20<06:20,  4.01s/steps, loss=0.25887382]      6%|▌         | 6/100 [00:24<06:14,  3.99s/steps, loss=0.25887382]      6%|▌         | 6/100 [00:24<06:14,  3.99s/steps, loss=0.2567211]       7%|▋         | 7/100 [00:28<06:19,  4.08s/steps, loss=0.2567211]      7%|▋         | 7/100 [00:28<06:19,  4.08s/steps, loss=0.25766137]      8%|▊         | 8/100 [00:32<06:06,  3.98s/steps, loss=0.25766137]      8%|▊         | 8/100 [00:32<06:06,  3.98s/steps, loss=0.24981524]      9%|▉         | 9/100 [00:36<06:13,  4.10s/steps, loss=0.24981524]      9%|▉         | 9/100 [00:36<06:13,  4.10s/steps, loss=0.24560474]     10%|█         | 10/100 [00:40<06:04,  4.05s/steps, loss=0.24560474]     10%|█         | 10/100 [00:40<06:04,  4.05s/steps, loss=0.2456706]      11%|█         | 11/100 [00:44<05:56,  4.00s/steps, loss=0.2456706]     11%|█         | 11/100 [00:44<05:56,  4.00s/steps, loss=0.24245653]     12%|█▏        | 12/100 [00:48<05:53,  4.02s/steps, loss=0.24245653]     12%|█▏        | 12/100 [00:48<05:53,  4.02s/steps, loss=0.24289368]     13%|█▎        | 13/100 [00:52<05:55,  4.08s/steps, loss=0.24289368]     13%|█▎        | 13/100 [00:52<05:55,  4.08s/steps, loss=0.24238126]     14%|█▍        | 14/100 [00:56<05:48,  4.05s/steps, loss=0.24238126]     14%|█▍        | 14/100 [00:56<05:48,  4.05s/steps, loss=0.23623775]     15%|█▌        | 15/100 [01:00<05:44,  4.06s/steps, loss=0.23623775]     15%|█▌        | 15/100 [01:00<05:44,  4.06s/steps, loss=0.23244229]     16%|█▌        | 16/100 [01:04<05:31,  3.95s/steps, loss=0.23244229]     16%|█▌        | 16/100 [01:04<05:31,  3.95s/steps, loss=0.23245163]     17%|█▋        | 17/100 [01:08<05:26,  3.93s/steps, loss=0.23245163]     17%|█▋        | 17/100 [01:08<05:26,  3.93s/steps, loss=0.23270036]     18%|█▊        | 18/100 [01:12<05:19,  3.89s/steps, loss=0.23270036]     18%|█▊        | 18/100 [01:12<05:19,  3.89s/steps, loss=0.23344332]     19%|█▉        | 19/100 [01:15<05:02,  3.74s/steps, loss=0.23344332]     19%|█▉        | 19/100 [01:15<05:02,  3.74s/steps, loss=0.23451339]     20%|██        | 20/100 [01:19<04:57,  3.71s/steps, loss=0.23451339]     20%|██        | 20/100 [01:19<04:57,  3.71s/steps, loss=0.23315582]     21%|██        | 21/100 [01:22<04:41,  3.57s/steps, loss=0.23315582]     21%|██        | 21/100 [01:22<04:41,  3.57s/steps, loss=0.22929554]     22%|██▏       | 22/100 [01:25<04:30,  3.47s/steps, loss=0.22929554]     22%|██▏       | 22/100 [01:25<04:30,  3.47s/steps, loss=0.22723384]     23%|██▎       | 23/100 [01:29<04:28,  3.49s/steps, loss=0.22723384]     23%|██▎       | 23/100 [01:29<04:28,  3.49s/steps, loss=0.22759236]     24%|██▍       | 24/100 [01:32<04:20,  3.42s/steps, loss=0.22759236]     24%|██▍       | 24/100 [01:32<04:20,  3.42s/steps, loss=0.22733954]     25%|██▌       | 25/100 [01:35<04:12,  3.37s/steps, loss=0.22733954]     25%|██▌       | 25/100 [01:35<04:12,  3.37s/steps, loss=0.22711134]     26%|██▌       | 26/100 [01:39<04:12,  3.41s/steps, loss=0.22711134]     26%|██▌       | 26/100 [01:39<04:12,  3.41s/steps, loss=0.22787066]     27%|██▋       | 27/100 [01:42<04:04,  3.35s/steps, loss=0.22787066]     27%|██▋       | 27/100 [01:42<04:04,  3.35s/steps, loss=0.22733583]     28%|██▊       | 28/100 [01:45<03:59,  3.33s/steps, loss=0.22733583]     28%|██▊       | 28/100 [01:45<03:59,  3.33s/steps, loss=0.22506714]     29%|██▉       | 29/100 [01:49<03:59,  3.37s/steps, loss=0.22506714]     29%|██▉       | 29/100 [01:49<03:59,  3.37s/steps, loss=0.22349092]     30%|███       | 30/100 [01:52<03:57,  3.40s/steps, loss=0.22349092]     30%|███       | 30/100 [01:52<03:57,  3.40s/steps, loss=0.22269563]     31%|███       | 31/100 [01:56<04:00,  3.49s/steps, loss=0.22269563]     31%|███       | 31/100 [01:56<04:00,  3.49s/steps, loss=0.22169189]     32%|███▏      | 32/100 [01:59<03:51,  3.40s/steps, loss=0.22169189]     32%|███▏      | 32/100 [01:59<03:51,  3.40s/steps, loss=0.22135134]     33%|███▎      | 33/100 [02:02<03:43,  3.34s/steps, loss=0.22135134]     33%|███▎      | 33/100 [02:02<03:43,  3.34s/steps, loss=0.22247659]     34%|███▍      | 34/100 [02:06<03:41,  3.35s/steps, loss=0.22247659]     34%|███▍      | 34/100 [02:06<03:41,  3.35s/steps, loss=0.22259101]     35%|███▌      | 35/100 [02:09<03:33,  3.28s/steps, loss=0.22259101]     35%|███▌      | 35/100 [02:09<03:33,  3.28s/steps, loss=0.2217295]      36%|███▌      | 36/100 [02:12<03:26,  3.23s/steps, loss=0.2217295]     36%|███▌      | 36/100 [02:12<03:26,  3.23s/steps, loss=0.2201609]     37%|███▋      | 37/100 [02:15<03:26,  3.28s/steps, loss=0.2201609]     37%|███▋      | 37/100 [02:15<03:26,  3.28s/steps, loss=0.2194521]     38%|███▊      | 38/100 [02:18<03:19,  3.22s/steps, loss=0.2194521]     38%|███▊      | 38/100 [02:19<03:19,  3.22s/steps, loss=0.21897808]     39%|███▉      | 39/100 [02:22<03:14,  3.19s/steps, loss=0.21897808]     39%|███▉      | 39/100 [02:22<03:14,  3.19s/steps, loss=0.21863276]     40%|████      | 40/100 [02:25<03:14,  3.24s/steps, loss=0.21863276]     40%|████      | 40/100 [02:25<03:14,  3.24s/steps, loss=0.21899045]     41%|████      | 41/100 [02:28<03:08,  3.20s/steps, loss=0.21899045]     41%|████      | 41/100 [02:28<03:08,  3.20s/steps, loss=0.21950775]     42%|████▏     | 42/100 [02:31<03:03,  3.16s/steps, loss=0.21950775]     42%|████▏     | 42/100 [02:31<03:03,  3.16s/steps, loss=0.21936968]     43%|████▎     | 43/100 [02:34<03:03,  3.22s/steps, loss=0.21936968]     43%|████▎     | 43/100 [02:35<03:03,  3.22s/steps, loss=0.21883552]     44%|████▍     | 44/100 [02:38<02:58,  3.18s/steps, loss=0.21883552]     44%|████▍     | 44/100 [02:38<02:58,  3.18s/steps, loss=0.21848741]     45%|████▌     | 45/100 [02:41<02:53,  3.16s/steps, loss=0.21848741]     45%|████▌     | 45/100 [02:41<02:53,  3.16s/steps, loss=0.21835582]     46%|████▌     | 46/100 [02:44<02:53,  3.21s/steps, loss=0.21835582]     46%|████▌     | 46/100 [02:44<02:53,  3.21s/steps, loss=0.21834873]     47%|████▋     | 47/100 [02:47<02:48,  3.17s/steps, loss=0.21834873]     47%|████▋     | 47/100 [02:47<02:48,  3.17s/steps, loss=0.21849176]     48%|████▊     | 48/100 [02:50<02:46,  3.21s/steps, loss=0.21849176]     48%|████▊     | 48/100 [02:50<02:46,  3.21s/steps, loss=0.2184241]      49%|████▉     | 49/100 [02:53<02:41,  3.17s/steps, loss=0.2184241]     49%|████▉     | 49/100 [02:53<02:41,  3.17s/steps, loss=0.21794225]     50%|█████     | 50/100 [02:56<02:36,  3.14s/steps, loss=0.21794225]     50%|█████     | 50/100 [02:57<02:36,  3.14s/steps, loss=0.21727362]     51%|█████     | 51/100 [03:00<02:36,  3.19s/steps, loss=0.21727362]     51%|█████     | 51/100 [03:00<02:36,  3.19s/steps, loss=0.21692854]     52%|█████▏    | 52/100 [03:00<01:54,  2.39s/steps, loss=0.21692854]     52%|█████▏    | 52/100 [03:00<01:54,  2.39s/steps, loss=0.21670607]     53%|█████▎    | 53/100 [03:01<01:25,  1.83s/steps, loss=0.21670607]     53%|█████▎    | 53/100 [03:01<01:25,  1.83s/steps, loss=0.21710908]     54%|█████▍    | 54/100 [03:01<01:06,  1.44s/steps, loss=0.21710908]     54%|█████▍    | 54/100 [03:01<01:06,  1.44s/steps, loss=0.21744469]     55%|█████▌    | 55/100 [03:02<00:52,  1.16s/steps, loss=0.21744469]     55%|█████▌    | 55/100 [03:02<00:52,  1.16s/steps, loss=0.21697351]     56%|█████▌    | 56/100 [03:02<00:42,  1.03steps/s, loss=0.21697351]     56%|█████▌    | 56/100 [03:02<00:42,  1.03steps/s, loss=0.2168967]      57%|█████▋    | 57/100 [03:03<00:35,  1.20steps/s, loss=0.2168967]     57%|█████▋    | 57/100 [03:03<00:35,  1.20steps/s, loss=0.21694818]     58%|█████▊    | 58/100 [03:03<00:31,  1.35steps/s, loss=0.21694818]     58%|█████▊    | 58/100 [03:03<00:31,  1.35steps/s, loss=0.21701203]     59%|█████▉    | 59/100 [03:04<00:27,  1.48steps/s, loss=0.21701203]     59%|█████▉    | 59/100 [03:04<00:27,  1.48steps/s, loss=0.21659686]     60%|██████    | 60/100 [03:05<00:28,  1.42steps/s, loss=0.21659686]     60%|██████    | 60/100 [03:05<00:28,  1.42steps/s, loss=0.21629608]     61%|██████    | 61/100 [03:05<00:25,  1.54steps/s, loss=0.21629608]     61%|██████    | 61/100 [03:05<00:25,  1.54steps/s, loss=0.21642983]     62%|██████▏   | 62/100 [03:06<00:23,  1.63steps/s, loss=0.21642983]     62%|██████▏   | 62/100 [03:06<00:23,  1.63steps/s, loss=0.21589094]     63%|██████▎   | 63/100 [03:06<00:21,  1.70steps/s, loss=0.21589094]     63%|██████▎   | 63/100 [03:06<00:21,  1.70steps/s, loss=0.21545875]     64%|██████▍   | 64/100 [03:07<00:20,  1.76steps/s, loss=0.21545875]     64%|██████▍   | 64/100 [03:07<00:20,  1.76steps/s, loss=0.21515575]     65%|██████▌   | 65/100 [03:07<00:19,  1.80steps/s, loss=0.21515575]     65%|██████▌   | 65/100 [03:07<00:19,  1.80steps/s, loss=0.21520948]     66%|██████▌   | 66/100 [03:08<00:18,  1.83steps/s, loss=0.21520948]     66%|██████▌   | 66/100 [03:08<00:18,  1.83steps/s, loss=0.21527912]     67%|██████▋   | 67/100 [03:08<00:17,  1.85steps/s, loss=0.21527912]     67%|██████▋   | 67/100 [03:08<00:17,  1.85steps/s, loss=0.21560252]     68%|██████▊   | 68/100 [03:09<00:17,  1.86steps/s, loss=0.21560252]     68%|██████▊   | 68/100 [03:09<00:17,  1.86steps/s, loss=0.21554147]     69%|██████▉   | 69/100 [03:10<00:18,  1.66steps/s, loss=0.21554147]     69%|██████▉   | 69/100 [03:10<00:18,  1.66steps/s, loss=0.21526702]     70%|███████   | 70/100 [03:10<00:18,  1.65steps/s, loss=0.21526702]     70%|███████   | 70/100 [03:10<00:18,  1.65steps/s, loss=0.2151828]      71%|███████   | 71/100 [03:11<00:17,  1.64steps/s, loss=0.2151828]     71%|███████   | 71/100 [03:11<00:17,  1.64steps/s, loss=0.21491994]     72%|███████▏  | 72/100 [03:11<00:16,  1.65steps/s, loss=0.21491994]     72%|███████▏  | 72/100 [03:12<00:16,  1.65steps/s, loss=0.21487093]     73%|███████▎  | 73/100 [03:12<00:16,  1.66steps/s, loss=0.21487093]     73%|███████▎  | 73/100 [03:12<00:16,  1.66steps/s, loss=0.21470317]     74%|███████▍  | 74/100 [03:13<00:15,  1.68steps/s, loss=0.21470317]     74%|███████▍  | 74/100 [03:13<00:15,  1.68steps/s, loss=0.2145325]      75%|███████▌  | 75/100 [03:13<00:14,  1.71steps/s, loss=0.2145325]     75%|███████▌  | 75/100 [03:13<00:14,  1.71steps/s, loss=0.21447156]     76%|███████▌  | 76/100 [03:14<00:13,  1.72steps/s, loss=0.21447156]     76%|███████▌  | 76/100 [03:14<00:13,  1.72steps/s, loss=0.21479544]     77%|███████▋  | 77/100 [03:14<00:13,  1.73steps/s, loss=0.21479544]     77%|███████▋  | 77/100 [03:14<00:13,  1.73steps/s, loss=0.21450949]     78%|███████▊  | 78/100 [03:15<00:14,  1.51steps/s, loss=0.21450949]     78%|███████▊  | 78/100 [03:15<00:14,  1.51steps/s, loss=0.21452829]     79%|███████▉  | 79/100 [03:16<00:13,  1.57steps/s, loss=0.21452829]     79%|███████▉  | 79/100 [03:16<00:13,  1.57steps/s, loss=0.21454383]     80%|████████  | 80/100 [03:16<00:12,  1.62steps/s, loss=0.21454383]     80%|████████  | 80/100 [03:16<00:12,  1.62steps/s, loss=0.21462193]     81%|████████  | 81/100 [03:17<00:11,  1.66steps/s, loss=0.21462193]     81%|████████  | 81/100 [03:17<00:11,  1.66steps/s, loss=0.21451971]     82%|████████▏ | 82/100 [03:18<00:10,  1.68steps/s, loss=0.21451971]     82%|████████▏ | 82/100 [03:18<00:10,  1.68steps/s, loss=0.21421094]     83%|████████▎ | 83/100 [03:18<00:10,  1.70steps/s, loss=0.21421094]     83%|████████▎ | 83/100 [03:18<00:10,  1.70steps/s, loss=0.21429968]     84%|████████▍ | 84/100 [03:19<00:09,  1.72steps/s, loss=0.21429968]     84%|████████▍ | 84/100 [03:19<00:09,  1.72steps/s, loss=0.21428584]     85%|████████▌ | 85/100 [03:19<00:08,  1.72steps/s, loss=0.21428584]     85%|████████▌ | 85/100 [03:19<00:08,  1.72steps/s, loss=0.21430157]     86%|████████▌ | 86/100 [03:20<00:08,  1.73steps/s, loss=0.21430157]     86%|████████▌ | 86/100 [03:20<00:08,  1.73steps/s, loss=0.2140781]      87%|████████▋ | 87/100 [03:21<00:08,  1.51steps/s, loss=0.2140781]     87%|████████▋ | 87/100 [03:21<00:08,  1.51steps/s, loss=0.2139607]     88%|████████▊ | 88/100 [03:21<00:07,  1.57steps/s, loss=0.2139607]     88%|████████▊ | 88/100 [03:21<00:07,  1.57steps/s, loss=0.21417035]     89%|████████▉ | 89/100 [03:22<00:06,  1.61steps/s, loss=0.21417035]     89%|████████▉ | 89/100 [03:22<00:06,  1.61steps/s, loss=0.2140465]      90%|█████████ | 90/100 [03:22<00:06,  1.64steps/s, loss=0.2140465]     90%|█████████ | 90/100 [03:23<00:06,  1.64steps/s, loss=0.21416532]     91%|█████████ | 91/100 [03:23<00:05,  1.67steps/s, loss=0.21416532]     91%|█████████ | 91/100 [03:23<00:05,  1.67steps/s, loss=0.21439819]     92%|█████████▏| 92/100 [03:24<00:04,  1.69steps/s, loss=0.21439819]     92%|█████████▏| 92/100 [03:24<00:04,  1.69steps/s, loss=0.21429777]     93%|█████████▎| 93/100 [03:24<00:04,  1.71steps/s, loss=0.21429777]     93%|█████████▎| 93/100 [03:24<00:04,  1.71steps/s, loss=0.21403481]     94%|█████████▍| 94/100 [03:25<00:03,  1.71steps/s, loss=0.21403481]     94%|█████████▍| 94/100 [03:25<00:03,  1.71steps/s, loss=0.21398]        95%|█████████▌| 95/100 [03:25<00:02,  1.72steps/s, loss=0.21398]     95%|█████████▌| 95/100 [03:25<00:02,  1.72steps/s, loss=0.21390338]     96%|█████████▌| 96/100 [03:26<00:02,  1.73steps/s, loss=0.21390338]     96%|█████████▌| 96/100 [03:26<00:02,  1.73steps/s, loss=0.21397828]     97%|█████████▋| 97/100 [03:27<00:01,  1.56steps/s, loss=0.21397828]     97%|█████████▋| 97/100 [03:27<00:01,  1.56steps/s, loss=0.2140422]      98%|█████████▊| 98/100 [03:27<00:01,  1.66steps/s, loss=0.2140422]     98%|█████████▊| 98/100 [03:27<00:01,  1.66steps/s, loss=0.2136046]     99%|█████████▉| 99/100 [03:28<00:00,  1.73steps/s, loss=0.2136046]     99%|█████████▉| 99/100 [03:28<00:00,  1.73steps/s, loss=0.21332498]    100%|██████████| 100/100 [03:28<00:00,  1.78steps/s, loss=0.21332498]    100%|██████████| 100/100 [03:28<00:00,  2.09s/steps, loss=0.21332498]




.. GENERATED FROM PYTHON SOURCE LINES 255-259

.. image-sg:: /generated/autoexamples/GPU/images/mrinufft_learn_2d_sampling_pattern.gif
   :alt: example learn_samples
   :srcset: /generated/autoexamples/GPU/images/mrinufft_learn_2d_sampling_pattern.gif
   :class: sphx-glr-single-img

.. GENERATED FROM PYTHON SOURCE LINES 261-263

Trained trajectory
------------------

.. GENERATED FROM PYTHON SOURCE LINES 263-268

.. code-block:: Python

    model.eval()
    recon = model(mri_3D)
    plot_state(mri_3D, model.get_trajectory(True).detach().cpu().numpy(), recon, losses)
    plt.show()




.. image-sg:: /generated/autoexamples/GPU/images/sphx_glr_example_learn_straight_line_readouts_002.png
   :alt: MR Image, Reconstruction, Loss, Trajectory
   :srcset: /generated/autoexamples/GPU/images/sphx_glr_example_learn_straight_line_readouts_002.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 269-284

References
==========

.. [Proj] N. Chauffert, P. Weiss, J. Kahn and P. Ciuciu, "A Projection Algorithm for
          Gradient Waveforms Design in Magnetic Resonance Imaging," in
          IEEE Transactions on Medical Imaging, vol. 35, no. 9, pp. 2026-2039, Sept. 2016,
          doi: 10.1109/TMI.2016.2544251.
.. [Sparks] G. R. Chaithya, P. Weiss, G. Daval-Frérot, A. Massire, A. Vignaud and P. Ciuciu,
          "Optimizing Full 3D SPARKLING Trajectories for High-Resolution Magnetic
          Resonance Imaging," in IEEE Transactions on Medical Imaging, vol. 41, no. 8,
          pp. 2105-2117, Aug. 2022, doi: 10.1109/TMI.2022.3157269.
.. [Projector] Chaithya GR, and Philippe Ciuciu. 2023. "Jointly Learning Non-Cartesian
          k-Space Trajectories and Reconstruction Networks for 2D and 3D MR Imaging
          through Projection" Bioengineering 10, no. 2: 158.
          https://doi.org/10.3390/bioengineering10020158


.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (3 minutes 37.838 seconds)


.. _sphx_glr_download_generated_autoexamples_GPU_example_learn_straight_line_readouts.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: binder-badge

      .. image:: images/binder_badge_logo.svg
        :target: https://mybinder.org/v2/gh/mind-inria/mri-nufft/gh-pages?urlpath=lab/tree/examples/generated/autoexamples/GPU/example_learn_straight_line_readouts.ipynb
        :alt: Launch binder
        :width: 150 px

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: example_learn_straight_line_readouts.ipynb <example_learn_straight_line_readouts.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: example_learn_straight_line_readouts.py <example_learn_straight_line_readouts.py>`

    .. container:: sphx-glr-download sphx-glr-download-zip

      :download:`Download zipped: example_learn_straight_line_readouts.zip <example_learn_straight_line_readouts.zip>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
